# Multisig

## Dependencies

- Go
- terrad

### Install Go

Follow instructions at https://golang.org/dl/

### Install terrad

Run the following commands in a terminal:

```sh
git clone https://github.com/terra-money/core.git
cd core
git checkout v0.5.6
rm $(which terrad) # delete any currently installed versions
make install
```

Test that the installation was successful by running:

```sh
terrad version # should print `0.5.6`
```

# Instructions for multisig key holders

As a multisig key holder, you will be required to sign transactions.
The instructions below explain how to do this.

## Setup your key in terrad

- Setup a new private key

```sh
terrad keys add <name>
```

- Or recover an existing private key

```sh
terrad keys add <name> --recover
# Then enter your 24 word mnemonic
```

- Check the key was added and export the public key (`pubkey` JSON object)

```sh
terrad keys show <name>
```

For example, the public key of the account `test1` is `'{"@type":"/cosmos.crypto.secp256k1.PubKey","key":"AjszqFJDRAYbEjZMuiD+ChqzbUSGq/RRu3zr0R6iJB5b"}'`:

```console
‚ùØ terrad keys show test1
- name: test1
  type: local
  address: terra1x46rqay4d3cssq8gxxvqz8xt6nwlz4td20k38v
  pubkey: '{"@type":"/cosmos.crypto.secp256k1.PubKey","key":"AjszqFJDRAYbEjZMuiD+ChqzbUSGq/RRu3zr0R6iJB5b"}'
  mnemonic: ""
```

## Add the multisig as an account in terrad

You will be provided with a set of commands that adds the following as accounts in terrad:
1. Each of `n` keys to the multisig
2. The multisig

## Create a signature for a transaction

You will be sent:
- An unsigned transaction file (`unsigned_tx.json`)
- A signing command that will look similar to this:

```sh
# Instructions to sign a tx for multisig terra1...:
# - 1. set `multisig` to the name of the multisig in terrad (check the name with `terrad keys list`):
multisig=...

# - 2. set `from` to your address that is a key to the multisig, or its name in terrad:
from=terra1...

# - 3. run the signing command:
terrad tx sign unsigned_tx.json \
  --multisig $multisig \
  --from $from \
  ...
```

You need to:
- Open a terminal
- Change directory to the location of the `unsigned_tx.json` file

```sh
cd path/to/directory
```

- Inspect the messages to be executed in the unsigned transaction.

:warning: **Do not blindly sign transactions** :warning:

```sh
# For messages executed on a contract:
jq ".body.messages[0].execute_msg" unsigned_tx.json

# For messages executed via proxy contracts:
jq ".body.messages[0].execute_msg.execute.msgs[0].wasm.execute.msg" unsigned_tx.json | tr -d '\"' | base64 -d
```

- Set `multisig` to the name of the multisig in terrad (check the name with `terrad keys list`). If the name of your multisig is `mars_multisig`, then do:

```sh
multisig=mars_multisig
```

- Replace `terra1...` in the signing command with your address. If your address is `terra1youraddress`, then do:

```sh
from=terra1youraddress
```

- Run the signing command:

```sh
terrad tx sign unsigned_tx.json \
  --multisig=$multisig \
  --from=$from \
  ...
```

Enter your login password if prompted to do so. You may be prompted multiple times.

- Return the signature file that is generated by running the command (e.g. `terra1youraddress_sig.json`)

# Instructions for creators of multisig transactions

As a multisig transaction creator, you will be required to create unsigned transactions.
The instructions below explain how to do this.

## Create a multisig in terrad

- Collect public keys of private keys that will be signers on the multisig. Ask key holders to send the `pubkey` field from the output of the following command:

```sh
terrad keys show <name>
```

- Add the public keys to terrad:

```sh
terrad keys add <name> --pubkey '{"@type":"<type>","key":"<key>"}'
```

- Create a multisig from the public keys:

```sh
terrad keys add <multisig_name> \
  --multisig <name_1>,<name_2>[,<name_3>...] \
  --multisig-threshold <k>
```

- Before the multisig can be used, it must be created on chain by sending some funds to its address. These funds can then be used to pay transaction fees.

## Create an unsigned transaction

- Populate a `.env` file with the required environment variables from `create_unsigned_tx.ts`
- Create an unsigned transaction (`unsigned_tx.json`):

```sh
node --loader ts-node/esm create_unsigned_tx.ts
```

- Distribute the following to multisig key holders:
  - `unsigned_tx.json`
  - The command that was printed to stdout by `create_unsigned_tx.ts`

## Broadcast a transaction

- Collect signatures from multisig key holders
- Populate a `.env` file with the required environment variables from `broadcast_tx.ts`
- Sign the transaction and broadcast it to the network:

```sh
node --loader ts-node/esm broadcast_tx.ts
```
